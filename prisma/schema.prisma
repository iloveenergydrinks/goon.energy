generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Hull {
  id              String   @id
  name            String
  description     String?
  sizeId          String
  archetype       String?
  powerCapacity   Int
  bandwidthLimit  Int
  compatibleTags  String[] @default([])
  incompatibleTags String[] @default([])
  preferredWeapons String[] @default([])
  baseStats       Json?
  grid            Json
  mismatchTolerance Float?
  slotBias        Json?
  tagAffinities   Json?
  tagPenalties    Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PrimarySystem {
  id            String   @id
  name          String
  description   String?
  icon          String?
  baseStats     Json?
  minPowerSlots Int      @default(0)
  minAmmoSlots  Int?
  powerDraw     Int      @default(30)
  tags          String[] @default([])
  archetypeFocus String[] @default([])
  tagAffinities Json?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SecondarySystem {
  id               String   @id
  name             String
  category         String
  description      String?
  baseStats        Json?
  deltaPowerSlots  Int      @default(0)
  deltaAmmoSlots   Int      @default(0)
  deltaUtilitySlots Int      @default(0)
  powerDraw        Int      @default(10)
  tags             String[] @default([])
  archetypeFocus   String[] @default([])
  tagAffinities    Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Module {
  id             String   @id
  familyId       String?
  familyName     String?
  variantTier    String?
  minHullSize    String?
  slot           String
  shape          Json
  stats          Json?
  description    String?
  baseBW         Int?
  tags           String[] @default([])
  archetypeBias  Json?
  tagAffinities  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations for manufacturing
  blueprints      Blueprint[]
  playerModules   PlayerModule[]
}

model ModuleType {
  id              String   @id
  name            String   @unique
  displayName     String
  description     String?
  
  // Visual settings
  color           String   // Hex color code for this module type
  icon            String?  // Optional icon identifier
  
  // Module characteristics
  baseBandwidth   Int      @default(10) // Base bandwidth cost for this type
  category        String   @default("custom") // Category: base, weapon, defense, utility, custom
  
  // Usage settings
  isActive        Boolean  @default(true)
  isSystemType    Boolean  @default(false) // True for Power, Ammo, Utility
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CustomSlotType {
  id              String   @id
  name            String   @unique
  displayName     String
  description     String?
  
  // Compatibility settings
  accepts         String[] // Array of module types this slot accepts (can include custom types)
  preferredType   String?  // Preferred module type (for bandwidth optimization)
  bwMultiplier    Float    @default(1.2) // Bandwidth multiplier for non-preferred types
  
  // Visual settings
  color           String   // Hex color code
  icon            String?  // Optional icon identifier
  
  // Usage settings
  isActive        Boolean  @default(true)
  isSystemSlot    Boolean  @default(false) // True for built-in slots like Hybrid-PA
  archetypeHints  String[] @default([]) // Suggested archetypes for this slot
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Industrial System Tables

model Player {
  id              String   @id @default(cuid())
  name            String   @unique
  isk             BigInt   @default(1000000)  // Using isk as column but calling it ORE in UI
  manufacturingMastery Int @default(0) // Overall mastery level
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  materials       PlayerMaterial[]
  components      PlayerComponent[]
  resourceNodes   ResourceNode[]
  miningOps       MiningOperation[]
  blueprints      PlayerBlueprint[]
  refiningJobs    RefiningJob[]
  manufacturingJobs ManufacturingJob[]
  upgrades        PlayerUpgrades?
  modules         PlayerModule[]  // Crafted modules inventory
}

model PlayerUpgrades {
  id              String   @id @default(cuid())
  playerId        String   @unique
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  clickPower      Int      @default(1)
  autoMiners      Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ResourceNode {
  id              String   @id @default(cuid())
  name            String
  type            String   // asteroid, gas_cloud, planetary, salvage
  tier            Int      // 1-5
  
  // Resource properties
  resourceType    String   // titanium, plasma, quantum, etc.
  totalAmount     BigInt   // Total mineable amount
  currentAmount   BigInt   // Current remaining amount
  baseYield       Int      @default(100) // Base units per click
  purity          Float    @default(0.3) // Base purity 0-1
  
  // Location
  sector          String
  coordinates     Json     // [x, y, z]
  
  // Status
  active          Boolean  @default(true)
  depleted        Boolean  @default(false)
  respawnAt       DateTime?
  
  // Ownership
  discoveredBy    String?
  discoveredAt    DateTime?
  player          Player?  @relation(fields: [discoveredBy], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  miningOps       MiningOperation[]
  
  @@index([active, depleted])
  @@index([sector])
}

model Material {
  id              String   @id @default(cuid())
  name            String
  category        String   // metal, gas, crystal, composite, exotic
  baseValue       Int      @default(100)
  
  // Base attributes (for newly mined materials)
  baseAttributes  Json     // { strength, conductivity, density, reactivity, stability, elasticity }
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  playerMaterials PlayerMaterial[]
}

model PlayerMaterial {
  id              String   @id @default(cuid())
  playerId        String
  materialId      String
  
  // Instance properties
  quantity        BigInt
  tier            Int      // 1-5
  purity          Float    // 0-1
  attributes      Json     // Actual attributes for this stack
  
  // Relations
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  material        Material @relation(fields: [materialId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([playerId, materialId, tier, purity])
  @@index([playerId])
}

model PlayerComponent {
  id              String   @id @default(cuid())
  playerId        String
  componentId     String   // e.g., 'flux_dust', 'quantum_processor'
  
  // Component details
  quantity        BigInt
  quality         Int      @default(100) // 1-100 quality rating
  
  // Relations
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([playerId, componentId, quality])
  @@index([playerId])
}

model MiningOperation {
  id              String   @id @default(cuid())
  playerId        String
  nodeId          String
  
  // Mining details
  materialGained  String   // Material type
  quantityMined   BigInt
  purityGained    Float
  tierGained      Int
  
  // Timestamp
  minedAt         DateTime @default(now())
  
  // Relations
  player          Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  node            ResourceNode @relation(fields: [nodeId], references: [id])
  
  @@index([playerId])
  @@index([nodeId])
}

model Blueprint {
  id                  String   @id @default(cuid())
  name               String   @unique
  description        String?
  type               String   // module, primary, secondary, hull
  
  // What it creates
  moduleId           String?  // Reference to module this creates
  module             Module?  @relation(fields: [moduleId], references: [id])
  
  // Recipe
  requiredMaterials  Json     // Array of {materialType: string, quantity: number}
  requiredComponents Json?    // Array of {componentId: string, quantity: number}
  baseStats          Json     // Base stats of the crafted item
  
  // Progression
  tier               Int      @default(1) // Blueprint tier (1=basic, 2=advanced, 3=elite)
  masteryRequired    Int      @default(0) // Minimum mastery level to craft
  
  // Relations
  manufacturingJobs  ManufacturingJob[]
  playerBlueprints   PlayerBlueprint[]
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model PlayerBlueprint {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])
  blueprintId String
  blueprint   Blueprint @relation(fields: [blueprintId], references: [id])
  unlocked    Boolean  @default(true)
  timesUsed   Int      @default(0) // Track usage for mastery
  createdAt   DateTime @default(now())
  
  @@unique([playerId, blueprintId])
}

model RefiningJob {
  id              String   @id @default(cuid())
  playerId        String
  materialId      String
  
  // Input details
  inputQuantity   BigInt
  inputPurity     Float
  inputTier       Int
  cycleNumber     Int
  
  // Facility details
  facilityType    String   // basic, standard, advanced, specialized, capital
  facilityEfficiency Float @default(0.7)
  
  // Output details
  outputQuantity  BigInt?
  outputPurity    Float?
  outputTier      Int?
  wasteQuantity   BigInt?
  
  // Status
  status          String   @default("pending") // pending, processing, completed, failed
  startedAt       DateTime @default(now())
  completedAt     DateTime?

  // Scheduling and assignment
  estimatedCompletion DateTime?
  captainId      String?
  batchId        String?
  
  // Relations
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([playerId])
  @@index([status])
}

model PlayerModule {
  id          String   @id @default(cuid())
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id])
  moduleId    String
  module      Module   @relation(fields: [moduleId], references: [id])
  blueprintId String?  // Which blueprint was used to craft this
  quality     Float    // Quality multiplier (0.7 - 1.3)
  stats       Json     // Final calculated stats
  equipped    Boolean  @default(false)
  shipId      String?  // If equipped, which ship
  createdAt   DateTime @default(now())
  
  @@index([playerId])
}

model ManufacturingJob {
  id              String   @id @default(cuid())
  playerId        String
  blueprintId     String
  
  // Materials used (JSON array)
  materials       Json     // Array of { materialId, quantity, tier, purity }
  
  // Facility details
  facilityType    String   // basic, standard, advanced, capital
  facilityQualityBonus Float @default(1.0)
  
  // Output details
  outputType      String   // module, hull, primary, secondary
  outputId        String?  // ID of created item
  outputQuality   Float?   // 0-100 quality score
  statBonuses     Json?    // Bonus stats from materials
  
  // Status
  status          String   @default("pending") // pending, processing, completed, failed
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  estimatedTime   Int      // Seconds to complete
  estimatedCompletion DateTime?

  // Scheduling and assignment
  captainId       String?
  batchId         String?
  batchIndex      Int?     // position within batch
  batchSize       Int      @default(1)
  
  // Relations
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  blueprint       Blueprint @relation(fields: [blueprintId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([playerId])
  @@index([status])
  @@index([blueprintId])
}

